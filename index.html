<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خياط اليرموك- نظام الإدارة المتكامل</title>
    <style>
        :root { --gold: #d4af37; --brown: #5d4037; --bg: #fdfbf7; --white: #ffffff; --red: #ff4d4d; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 10px; direction: rtl; }
        
        .main-container { max-width: 600px; margin: auto; background: var(--white); border-radius: 20px; border: 1px solid var(--gold); box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; padding-bottom: 20px;}
        
        /* الهيدر والتبويبات */
        .welcome-banner { background: var(--brown); color: white; padding: 12px; text-align: center; font-size: 13px; }
        .header { text-align: center; padding: 15px; border-bottom: 2px solid var(--gold); }
        .main-tabs { display: flex; background: #eee; }
        .tab-btn { flex: 1; padding: 15px; border: none; cursor: pointer; font-weight: bold; background: #eee; transition: 0.3s; }
        .tab-btn.active { background: var(--gold); color: white; }

        .section { display: none; padding: 15px; }
        .section.active { display: block; }

        /* المنتجات والمخزون */
        .items-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .product-card { border: 1px solid #eee; border-radius: 15px; position: relative; background: white; padding-bottom: 10px; overflow: hidden; }
        .product-card img { width: 100%; height: 120px; object-fit: cover; }
        .stock-tag { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; }
        
        /* أزرار الإدارة داخل البطاقة */
        .admin-controls { display: flex; gap: 5px; padding: 5px; justify-content: center; }
        .edit-btn { background: #28a745; color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 10px; cursor: pointer; }
        .delete-btn { background: var(--red); color: white; border: none; border-radius: 5px; padding: 5px 10px; font-size: 10px; cursor: pointer; }

        /* لوحة الإدارة */
        .admin-panel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center; }
        .admin-content { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; color: #333; }
        .admin-content input, .admin-content select { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }

        .btn-send { width: 90%; display: block; margin: 20px auto; padding: 15px; background: var(--brown); color: white; border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .settings-btn { position: fixed; bottom: 20px; left: 20px; background: white; border: 1px solid var(--gold); border-radius: 50%; width: 50px; height: 50px; cursor: pointer; z-index: 1000; }
        
        .measure-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; background: #f9f9f9; padding: 10px; border-radius: 10px; }
        .measure-grid input { width: 100%; padding: 5px; text-align: center; border: 1px solid #ddd; border-radius: 4px; }
        
        .selected-thobe-card { background: #fff9eb; border: 1px solid var(--gold); border-radius: 10px; padding: 10px; margin-bottom: 10px; position: relative; }
    </style>
</head>
<body>

<div class="welcome-banner">إرث الوالد يرحب بك في اليرموك الحديث ✨</div>

<button class="settings-btn" onclick="openAdmin()">⚙️</button>

<div class="main-container">
    <div class="header">
        <h2 style="margin:0; color:var(--brown)">اليرموك الحديث</h2>
        <p style="font-size: 12px; color: #888;">نظام إدارة المخزون والطلبات</p>
    </div>

    <div style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" id="c_name" placeholder="اسم العميل" style="flex:2; padding:10px; border-radius:8px; border:1px solid #ddd;">
        <input type="tel" id="c_phone" placeholder="رقم الهاتف" style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;">
    </div>

    <div class="main-tabs">
        <button class="tab-btn active" onclick="switchMainTab('tailor')">التفصيل</button>
        <button class="tab-btn" onclick="switchMainTab('ready')">الجاهز والمخزون</button>
    </div>

    <div id="section_tailor" class="section active">
        <div class="measure-grid">
            <div><label style="font-size:10px;">طول</label><input type="number" class="m-input"></div>
            <div><label style="font-size:10px;">كتف</label><input type="number" class="m-input"></div>
            <div><label style="font-size:10px;">يد</label><input type="number" class="m-input"></div>
            <div><label style="font-size:10px;">صدر</label><input type="number" class="m-input"></div>
        </div>
        <br>
        <button onclick="openFabricModal()" style="width:100%; padding:12px; background:none; border:2px dashed var(--gold); color:var(--gold); font-weight:bold; border-radius:10px; cursor:pointer;">+ إضافة قماش من المخزون</button>
        <div id="tailor_list" style="margin-top:15px;"></div>
    </div>

    <div id="section_ready" class="section">
        <div id="ready_display" class="items-grid"></div>
    </div>

    <div style="background:var(--brown); color:white; padding:15px; text-align:center; margin-top:20px;">
        <h3 style="margin:0;">الإجمالي: <span id="final_total">0</span> ريال</h3>
    </div>
    <button class="btn-send" onclick="submitOrder()">تأكيد الطلب</button>
</div>

<div id="adminPanel" class="admin-panel">
    <div class="admin-content">
        <h3 id="admin_title_text">إضافة منتج جديد</h3>
        <input type="hidden" id="edit_index" value="-1">
        <select id="adm_cat">
            <option value="fabric">أقمشة تفصيل</option>
            <option value="thobe_r">ثياب جاهزة</option>
            <option value="coat_r">أكوات</option>
        </select>
        <input type="text" id="adm_name" placeholder="اسم المنتج">
        <input type="number" id="adm_price" placeholder="السعر">
        <input type="number" id="adm_qty" placeholder="الكمية المتوفرة (المخزون)">
        <input type="file" id="adm_file" onchange="encodeImg(this)">
        <button onclick="saveProduct()" style="width:100%; padding:12px; background:var(--gold); border:none; color:white; border-radius:8px; font-weight:bold;">حفظ في الذاكرة الدائمة</button>
        <button onclick="closeAdmin()" style="width:100%; background:none; border:none; color:999; margin-top:10px;">إلغاء</button>
    </div>
</div>

<div id="fabricModal" class="admin-panel">
    <div class="admin-content">
        <h3>اختر قماش من المخزون</h3>
        <div id="modal_fabric_list" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; max-height:300px; overflow-y:auto;"></div>
        <button onclick="document.getElementById('fabricModal').style.display='none'" style="width:100%; margin-top:15px;">إغلاق</button>
    </div>
</div>

<script>
    // نظام التخزين الدائم (LocalStorage)
    let db = JSON.parse(localStorage.getItem('yarmouk_db')) || { products: [] };
    let tempImg = "";
    let cart = [];

    function saveToStorage() {
        localStorage.setItem('yarmouk_db', JSON.stringify(db));
        renderProducts();
    }

    function openAdmin() {
        if(prompt("كلمة مرور الإدارة:") === "1234") {
            document.getElementById('edit_index').value = "-1";
            document.getElementById('admin_title_text').innerText = "إضافة منتج جديد";
            document.getElementById('adminPanel').style.display = 'flex';
        }
    }

    function closeAdmin() { document.getElementById('adminPanel').style.display = 'none'; tempImg = ""; }

    function encodeImg(i) {
        let r = new FileReader();
        r.onload = (e) => tempImg = e.target.result;
        r.readAsDataURL(i.files[0]);
    }

    function saveProduct() {
        const index = parseInt(document.getElementById('edit_index').value);
        const newProduct = {
            cat: document.getElementById('adm_cat').value,
            name: document.getElementById('adm_name').value,
            price: parseInt(document.getElementById('adm_price').value),
            qty: parseInt(document.getElementById('adm_qty').value),
            img: tempImg || (index !== -1 ? db.products[index].img : "")
        };

        if(index === -1) {
            db.products.push(newProduct);
        } else {
            db.products[index] = newProduct;
        }

        saveToStorage();
        closeAdmin();
        alert("تم حفظ البيانات بنجاح!");
    }

    function deleteProduct(index) {
        if(confirm("هل أنت متأكد من حذف هذا المنتج نهائياً؟")) {
            db.products.splice(index, 1);
            saveToStorage();
        }
    }

    function editProduct(index) {
        const p = db.products[index];
        document.getElementById('edit_index').value = index;
        document.getElementById('adm_cat').value = p.cat;
        document.getElementById('adm_name').value = p.name;
        document.getElementById('adm_price').value = p.price;
        document.getElementById('adm_qty').value = p.qty;
        document.getElementById('admin_title_text').innerText = "تعديل المنتج";
        document.getElementById('adminPanel').style.display = 'flex';
    }

    function renderProducts() {
        const display = document.getElementById('ready_display');
        const fabrics = db.products.filter(p => p.cat === 'fabric');
        const ready = db.products.filter(p => p.cat !== 'fabric');

        display.innerHTML = ready.map((p, i) => {
            const realIndex = db.products.indexOf(p);
            return `
                <div class="product-card">
                    <span class="stock-tag">المتبقي: ${p.qty}</span>
                    <img src="${p.img}">
                    <div style="padding:5px; text-align:center;">
                        <div style="font-weight:bold; font-size:13px;">${p.name}</div>
                        <div style="color:green; font-weight:bold;">${p.price} ريال</div>
                    </div>
                    <div class="admin-controls">
                        <button class="edit-btn" onclick="editProduct(${realIndex})">تعديل</button>
                        <button class="delete-btn" onclick="deleteProduct(${realIndex})">حذف</button>
                    </div>
                    <button onclick="addToCart(${realIndex})" style="width:100%; padding:8px; background:var(--gold); border:none; color:white; font-size:11px; cursor:pointer;" ${p.qty <= 0 ? 'disabled' : ''}>
                        ${p.qty > 0 ? 'إضافة للطلب' : 'نفذت الكمية'}
                    </button>
                </div>
            `;
        }).join('');
    }

    function openFabricModal() {
        const list = document.getElementById('modal_fabric_list');
        const fabrics = db.products.filter(p => p.cat === 'fabric');
        list.innerHTML = fabrics.map(p => {
            const realIndex = db.products.indexOf(p);
            return `
                <div onclick="addToCart(${realIndex})" style="border:1px solid #ddd; padding:5px; text-align:center; cursor:pointer;">
                    <img src="${p.img}" style="width:100%; height:50px; object-fit:cover;">
                    <div style="font-size:10px;">${p.name}</div>
                    <div style="font-size:10px; color:blue;">مخزون: ${p.qty}</div>
                </div>
            `;
        }).join('');
        document.getElementById('fabricModal').style.display = 'flex';
    }

    function addToCart(index) {
        const p = db.products[index];
        if(p.qty <= 0) return alert("عذراً، نفذت الكمية!");
        
        cart.push({...p, originalIndex: index});
        if(p.cat === 'fabric') {
            const id = Date.now();
            const card = document.createElement('div');
            card.className = 'selected-thobe-card';
            card.innerHTML = `<b>قماش: ${p.name}</b> - ${p.price} ريال <br> <small>سيتم خصم قطعة من المخزون عند التأكيد</small>`;
            document.getElementById('tailor_list').appendChild(card);
            document.getElementById('fabricModal').style.display = 'none';
        }
        calcTotal();
    }

    function calcTotal() {
        const total = cart.reduce((sum, item) => sum + item.price, 0);
        document.getElementById('final_total').innerText = total.toLocaleString();
    }

    function switchMainTab(t) {
        document.querySelectorAll('.section, .tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('section_'+t).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function submitOrder() {
        if(!document.getElementById('c_name').value) return alert("يرجى كتابة الاسم");
        if(cart.length === 0) return alert("السلة فارغة!");

        // خصم الكمية من المخزون
        cart.forEach(item => {
            db.products[item.originalIndex].qty -= 1;
        });

        saveToStorage(); // حفظ المخزون الجديد
        alert("تم تأكيد الطلب وخصم الكميات من المخزون بنجاح!");
        location.reload();
    }

    // التشغيل الأولي
    renderProducts();
</script>
</body>
</html>
